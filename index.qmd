
```{r}
#| echo: false
#| warning: false
#| message: false

# Load necessary libraries
library(quantmod)
library(dplyr)
library(plotly)
library(cansim)
library(lubridate)

# --- 1. Get Monthly Gold (CAD) ---
gold_symbol <- "GC=F"
cad_symbol  <- "CAD=X"

getSymbols(c(gold_symbol, cad_symbol), 
           from = "2024-12-01", 
           to = "2025-12-31", 
           src = "yahoo", 
           auto.assign = TRUE)

daily_gold_cad <- Ad(get(gold_symbol)) * Ad(get(cad_symbol))
monthly_gold_xts <- to.monthly(daily_gold_cad, indexAt = "firstof", OHLC = FALSE)

df_gold <- data.frame(
  Date = as.Date(index(monthly_gold_xts)), 
  Gold_Price_CAD = as.numeric(monthly_gold_xts)
)

# --- 2. Get CPI Data (StatCan v41690974) ---
raw_cpi <- get_cansim_vector("v41690974", 
                             start_time = "2025-01-01", 
                             end_time = "2025-12-31")

df_cpi <- raw_cpi %>%
  select(Date = REF_DATE, CPI = VALUE) %>%
  mutate(Date = as.Date(Date))

# --- 3. Merge & Calculate Metrics ---
plot_data <- inner_join(df_gold, df_cpi, by = "Date") %>%
  filter(Date >= "2025-01-01") %>%
  arrange(Date) %>%
  mutate(
    Base_Gold = first(Gold_Price_CAD),
    Base_CPI  = first(CPI),
    Gold_Pct_Change = (Gold_Price_CAD / Base_Gold - 1) * 100,
    CPI_Pct_Change  = (CPI / Base_CPI - 1) * 100,
    Real_CPI_vs_Gold = CPI_Pct_Change - Gold_Pct_Change
  )

# --- 4. Create the Plotly Chart ---
# Calculate a dynamic upper limit so the chart doesn't look cramped
upper_limit <- max(plot_data$Real_CPI_vs_Gold, 2) + 1

p <- plot_ly(data = plot_data, x = ~Date)

p <- add_trace(p,
               y = ~Real_CPI_vs_Gold,
               type = 'scatter',
               mode = 'lines',  # CHANGED: 'lines' only (removed +markers)
               line = list(color = '#336699', width = 2),
               name = "Real CPI (Gold Terms)",
               hoverinfo = "text",
               text = ~paste(
                 "<b>Date:</b>", format(Date, "%b %Y"),
                 "<br><b>Real Change:</b>", round(Real_CPI_vs_Gold, 2), "%",
                 "<br><i>(CPI:", round(CPI_Pct_Change, 1), "% | Gold:", round(Gold_Pct_Change, 1), "%)</i>"
               )
)

p <- p %>% layout(
  title = list(text = "<b>Price of food down 30% since start of year</b><br><sup>(Change in food CPI indexed to Jan 2025 priced in gold)</sup>"),
  xaxis = list(
    title = "",
    showgrid = FALSE,
    tickformat = "%b %Y",
    range=c("2024-12-01", "2025-11-01")
  ),
  yaxis = list(
    title = "Relative % Change (from Jan 2025)",
    showgrid = TRUE,
    gridcolor = "#e5e5e5",
    zeroline = TRUE,
    zerolinecolor = "black",
    zerolinewidth = 1,
    range = c(-40.1, upper_limit)
  ),
  showlegend = FALSE,
  hovermode = "closest",
  plot_bgcolor = "white",
  # Increase bottom margin to fit the citation
  margin = list(b = 80), 
  annotations = list(
    list(
      x = 0,
      y = -0.15, # Position below the X-axis
      text = "Source: Yahoo Finance (Gold Price) and Statistics Canada, Consumer Price Index (Table 18-10-0004-01)",
      showarrow = FALSE,
      xref = 'paper',
      yref = 'paper',
      xanchor = 'left',
      yanchor = 'auto',
      font = list(size = 10, color = "gray")
    )
  )
) %>%
  config(displayModeBar = FALSE)

# Display
p



```
